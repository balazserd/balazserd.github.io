<!DOCTYPE html>
<html>
<head>
  <title>Accept TripSplit Invite</title>
  <meta charset="utf-8" />
</head>
<body>
    <p id="tripInvitationTitle">You've been invited to join [trip_name] by [trip_owner]!</p>

    <!--Add buttons to initiate auth sequence and sign out.-->
    <button id="authorize_button" onclick="handleAuthClick()">Join</button>

    <pre id="content" style="white-space: pre-wrap;"></pre>

    <script type="text/javascript">
    /* exported gapiLoaded */
    /* exported gisLoaded */
    /* exported handleAuthClick */
    /* exported handleSignoutClick */

    // Authorization scopes required by the API; multiple scopes can be
    // included, separated by spaces.
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';

    // TODO(developer): Replace with your client ID and API key from https://console.cloud.google.com/.
    // const CLIENT_ID = '268504637547-g0ujnpbu7l94env7gtfb8t8tlq133loi.apps.googleusercontent.com';
    const CLIENT_ID = '268504637547-geafubhgg3nsdkrpssqo29gl8flpuqd6.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyDA-TJWsz_97_jsUM9TC22IT7vVD0E-ifY';

    // TODO(developer): Replace with your project number from https://console.cloud.google.com/.
    const APP_ID = '268504637547';
    
    const tripContainerFolderId = new URL(document.location.toString()).searchParams.get("tripid")

    let tokenClient;
    let accessToken = null;
    let pickerInited = false;
    let gisInited = false;

    document.getElementById('authorize_button').style.visibility = 'hidden';

    /**
     * Callback after api.js is loaded.
     */
    function gapiLoaded() {
        gapi.load('client:picker', initializePicker);
    }

    /**
     * Callback after the API client is loaded. Loads the
     * discovery doc to initialize the API.
     */
    async function initializePicker() {
        await gapi.client.load('https://www.googleapis.com/discovery/v1/apis/drive/v3/rest');
        pickerInited = true;
        maybeEnableButtons();
    }

    /**
     * Callback after Google Identity Services are loaded.
     */
    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: '', // defined later
        });
        gisInited = true;
        maybeEnableButtons();
    }

    /**
     * Enables user interaction after all libraries are loaded.
     */
    function maybeEnableButtons() {
        if (pickerInited && gisInited) {
            document.getElementById('authorize_button').style.visibility = 'visible';
        }
    }

    /**
     *  Sign in the user upon button click.
     */
    function handleAuthClick() {
        tokenClient.callback = async (response) => {
            if (response.error !== undefined) {
                throw (response);
            }
            accessToken = response.access_token;
            await createPicker();
        };

        if (accessToken === null) {
            // Prompt the user to select a Google Account and ask for consent to share their data
            // when establishing a new session.
            tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
            // Skip display of account chooser and consent dialog for an existing session.
            tokenClient.requestAccessToken({prompt: ''});
        }
    }

    /**
     *  Create and render a Google Picker object for searching images.
     */
    function createPicker() {
        const view = new google.picker.DocsView(google.picker.ViewId.FOLDERS)
            .setFileIds(tripContainerFolderId)
            .setSelectFolderEnabled(true);

        const picker = new google.picker.PickerBuilder()
            .enableFeature(google.picker.Feature.NAV_HIDDEN)
            .setDeveloperKey(API_KEY)
            .setAppId(APP_ID)
            .setOAuthToken(accessToken)
            .setTitle('Select the indicated folder to grant access to TripSplit')
            .addView(view)
            .setCallback(pickerCallback)
            .build();

        picker.setVisible(true);
    }

    /**
     * Displays the file details of the user's selection.
     * @param {object} data - Contains the user selection from the Google Picker.
     */
    async function pickerCallback(data) {
        if (data.action === google.picker.Action.PICKED) {
            let text = `Google Picker response: \n${JSON.stringify(data, null, 2)}\n`;
            const document = data[google.picker.Response.DOCUMENTS][0];
            const fileId = document[google.picker.Document.ID];

            console.log(fileId);

            gapi.client.setToken({ access_token: accessToken });

            const _r = await gapi.client.drive.files.list({
                "fields": "files(id,properties)",
                "supportsAllDrives": "true",
                "includeItemsFromAllDrives": "true",
                "corpora": "allDrives",
                "q": "properties has { key='tripSplit.entityType' and value='tripFolder' }" +
                    "and mimeType = 'application/vnd.google-apps.folder' " +
                    "and trashed = false"
            });

            console.log(_r);

            const res = await gapi.client.drive.files.get({
                'fileId': fileId,
                'fields': '*',
                'supportsAllDrives': true,
            });

            console.log(res);
            
            text += `Drive API response for first document: \n${JSON.stringify(res.result, null, 2)}\n`;
            window.document.getElementById('content').innerText = text;
        }
    }
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>